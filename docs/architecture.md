# アーキテクチャ

## 概要

mcp-server-play-sound は、Model Context Protocol (MCP) を使用して音声再生機能を提供するサーバーです。現在は macOS の システムサウンドを再生する機能を提供していますが、将来的には複数プラットフォームへの対応を視野に入れた設計となっています。

## システム構成

```
┌─────────────┐
│ Claude Code │
│  (Client)   │
└──────┬──────┘
       │ MCP (stdio)
       ↓
┌──────────────────────────────────────┐
│    mcp-server-play-sound (Server)    │
│                                      │
│  ┌────────────────────────────────┐ │
│  │  MCP Server (server package)   │ │
│  └────────────┬───────────────────┘ │
│               │                      │
│  ┌────────────↓───────────────────┐ │
│  │   Sound Tool (tools package)   │ │
│  └────────────┬───────────────────┘ │
│               │                      │
│  ┌────────────↓───────────────────┐ │
│  │ Platform Layer (platform pkg)  │ │
│  │  - macOS Player (osascript)    │ │
│  │  - Linux Player (将来)         │ │
│  │  - Windows Player (将来)       │ │
│  └────────────────────────────────┘ │
└──────────────────────────────────────┘
```

## パッケージ構造

### `cmd/server`
エントリーポイント。サーバーの初期化と起動を行います。

**責務:**
- `main()` 関数の提供
- サーバーの起動

### `internal/server`
MCP サーバーの初期化とツール登録を管理します。

**責務:**
- MCP サーバーインスタンスの作成
- ツールの登録
- プラットフォーム検出と適切な Player の選択
- 設定の読み込み

**主要な関数:**
- `New() *mcp.Server` - サーバーを作成
- `Run(ctx, server) error` - サーバーを起動

### `internal/tools`
MCP ツールの実装を提供します。

**責務:**
- `play_glass` ツールの実装
- 音量制御ロジック（取得・設定・復元）
- エラーハンドリング

**主要な型:**
- `SoundTool` - ツール実装のメインストラクチャ
- `PlayGlass()` - ツールハンドラー関数

### `internal/platform`
プラットフォーム固有の音声再生実装を提供します。

**責務:**
- `SoundPlayer` インターフェースの定義
- macOS 実装 (`MacOSPlayer`)
- 将来のプラットフォーム実装の基盤

**インターフェース:**
```go
type SoundPlayer interface {
    Play(ctx, soundFile, volume) error
    GetVolume(ctx) (int, error)
    SetVolume(ctx, volume) error
    PlatformName() string
}
```

**実装:**
- `MacOSPlayer` - osascript と afplay を使用

### `internal/types`
共通の型定義とエラー定義を提供します。

**責務:**
- Input/Output 型の定義
- Config 構造体の定義
- センチネルエラーの定義

**主要な型:**
- `Input` - ツール入力パラメータ
- `Output` - ツール出力結果
- `Config` - 設定情報
- `ErrUnsupportedPlatform`, `ErrVolumeControl`, `ErrSoundPlayback` - エラー定義

### `internal/config`
設定管理を提供します。

**責務:**
- 環境変数からの設定読み込み
- デフォルト設定の提供

**主要な関数:**
- `LoadFromEnv() *types.Config` - 環境変数から設定を読み込み

## データフロー

### 音声再生の流れ

```
1. Client (Claude Code) が play_glass ツールを呼び出し
   ↓
2. MCP Server がリクエストを受信
   ↓
3. SoundTool.PlayGlass() が実行される
   ↓
4. プラットフォームチェック（darwin のみ許可）
   ↓
5. 現在の音量を取得 (GetVolume)
   ↓
6. 音量を設定値に変更 (SetVolume)
   ↓
7. 音声ファイルを再生 (Play)
   ↓
8. 元の音量を復元 (SetVolume) ※設定で有効な場合
   ↓
9. 結果を Client に返却
```

### エラーハンドリング

```
音量取得失敗 → ログ出力 → 続行（Graceful Degradation）
音量設定失敗 → ログ出力 → 続行
音声再生失敗 → エラー返却（処理中断）
音量復元失敗 → ログ出力のみ（処理は成功扱い）
```

## 設計原則

### 1. プラットフォーム抽象化
`SoundPlayer` インターフェースにより、プラットフォーム固有のコードを分離。将来的な Linux/Windows 対応が容易。

### 2. Graceful Degradation
音量制御の失敗は致命的エラーとせず、音声再生自体は継続。ユーザー体験を優先。

### 3. 設定の柔軟性
環境変数による設定変更をサポート。デフォルト設定も適切に提供。

### 4. テスタビリティ
- インターフェースベースの設計
- モック可能な構造
- 依存性注入の活用

## 拡張ポイント

### 新しい音声の追加
1. `Config` に新しい音声ファイルパスを追加
2. 新しいツールを `internal/tools` に実装
3. `internal/server` でツールを登録

### 新しいプラットフォームの追加
1. `internal/platform` に新しい実装を追加（例: `linux.go`）
2. `SoundPlayer` インターフェースを実装
3. `internal/server` のプラットフォーム検出ロジックに追加

### 新しい機能の追加
1. 音声のストリーミング再生
2. 複数音声の同時再生
3. 音声の録音機能
4. カスタム音声ファイルのアップロード

## セキュリティ考慮事項

### コマンドインジェクション
- `osascript` と `afplay` の引数は固定またはバリデーション済みの値のみ使用
- ユーザー入力を直接コマンドに渡さない

### ファイルアクセス
- 音声ファイルパスは環境変数または設定ファイルで管理
- システムサウンドディレクトリ以外へのアクセスには注意

## パフォーマンス

### 音声再生の同期処理
- `afplay` は同期的に実行され、再生完了まで待機
- 長い音声ファイルの場合は注意が必要

### 音量制御のオーバーヘッド
- `osascript` の起動は軽量（数ミリ秒）
- 音量の取得・設定・復元で合計3回の `osascript` 呼び出し

## 今後の改善案

1. **非同期再生のサポート**
   - バックグラウンドでの音声再生
   - 再生中の音声の停止機能

2. **音声キャッシュ**
   - よく使う音声のプリロード
   - メモリ効率の向上

3. **ログの構造化**
   - `log/slog` への移行
   - ログレベルの導入

4. **メトリクス収集**
   - 再生回数の記録
   - エラー率の監視
